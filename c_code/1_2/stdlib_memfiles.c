/* Generated by Nim Compiler v0.10.3 */
/*   (c) 2015 Andreas Rumpf */
/* The generated code is subject to the original license. */
#define NIM_INTBITS 64
#include "nimbase.h"

#include <string.h>
typedef struct memfile248208 memfile248208;
typedef struct TNimType TNimType;
typedef struct TNimNode TNimNode;
typedef struct NimStringDesc NimStringDesc;
typedef struct TGenericSeq TGenericSeq;
struct  memfile248208  {
void* Mem;
NI Size;
NI Fhandle;
NI Maphandle;
};
typedef N_NIMCALL_PTR(void, TY3289) (void* p, NI op);
typedef N_NIMCALL_PTR(void*, TY3294) (void* p);
struct  TNimType  {
NI size;
NU8 kind;
NU8 flags;
TNimType* base;
TNimNode* node;
void* finalizer;
TY3289 marker;
TY3294 deepcopy;
};
struct  TNimNode  {
NU8 kind;
NI offset;
TNimType* typ;
NCSTRING name;
NI len;
TNimNode** sons;
};
struct  TGenericSeq  {
NI len;
NI reserved;
};
struct  NimStringDesc  {
  TGenericSeq Sup;
NIM_CHAR data[SEQ_DECL_SIZE];
};
typedef N_STDCALL_PTR(NI, TY105318) (NI16* lpfilename, NI32 dwdesiredaccess, NI32 dwsharemode, void* lpsecurityattributes, NI32 dwcreationdisposition, NI32 dwflagsandattributes, NI htemplatefile);
typedef N_STDCALL_PTR(NI32, TY103425) (NI hobject);
typedef N_STDCALL_PTR(NI32, TY105411) (NI hfile, NI32 ldistancetomove, NI32* lpdistancetomovehigh, NI32 dwmovemethod);
typedef N_STDCALL_PTR(NI32, TY105405) (NI hfile);
typedef N_STDCALL_PTR(NI, TY105440) (NI hfile, void* lpfilemappingattributes, NI32 flprotect, NI32 dwmaximumsizehigh, NI32 dwmaximumsizelow, void* lpname);
typedef N_STDCALL_PTR(void*, TY105429) (NI hfilemappingobject, NI32 dwdesiredaccess, NI32 dwfileoffsethigh, NI32 dwfileoffsetlow, NI32 dwnumberofbytestomap, void* lpbaseaddress);
typedef N_STDCALL_PTR(NI32, TY105421) (NI hfile, NI32* lpfilesizehigh);
typedef N_STDCALL_PTR(NI32, TY105602) (void* lpbaseaddress);
N_NIMCALL(NI16*, newwidecstring_80005)(NimStringDesc* s);
N_NIMCALL(void, raiseoserror_113430)(NI32 errorcode);
N_NIMCALL(NI32, oslasterror_113454)(void);
TNimType NTI248208; /* MemFile */
extern TNimType NTI153; /* pointer */
extern TNimType NTI108; /* int */
extern TY105318 Dl_105317;
extern TY103425 Dl_103424;
extern TY105411 Dl_105410;
extern TY105405 Dl_105404;
extern TY105440 Dl_105439;
extern TY105429 Dl_105428;
extern TY105421 Dl_105420;
extern TY105602 Dl_105601;

N_NIMCALL(memfile248208, open_248607)(NimStringDesc* filename, NU8 mode, NI mappedsize, NI offset, NI newfilesize) {
	memfile248208 result;
	NIM_BOOL readonly;
	NI16* LOC1;
	NI32 LOC2;
	NI32 LOC8;
	NI32 LOC14;
	NI32 LOC58;
	NI32 LOC79;
	NI LOC85;
	NI32 hi;
	NI32 low;
	memset((void*)(&result), 0, sizeof(result));
	readonly = (mode == ((NU8) 0));
	LOC1 = 0;
	LOC1 = newwidecstring_80005(filename);
	LOC2 = 0;
	{
		if (!readonly) goto LA5;
		LOC2 = ((NI32) (-2147483647 -1));
	}
	goto LA3;
	LA5: ;
	{
		LOC2 = ((NI32) 268435456);
	}
	LA3: ;
	LOC8 = 0;
	{
		if (!!((newfilesize == ((NI) -1)))) goto LA11;
		LOC8 = ((NI32) 2);
	}
	goto LA9;
	LA11: ;
	{
		LOC8 = ((NI32) 3);
	}
	LA9: ;
	LOC14 = 0;
	{
		if (!readonly) goto LA17;
		LOC14 = ((NI32) 1);
	}
	goto LA15;
	LA17: ;
	{
		LOC14 = ((NI32) 256);
	}
	LA15: ;
	result.Fhandle = Dl_105317(LOC1, LOC2, ((NI32) 1), NIM_NIL, LOC8, LOC14, ((NI) 0));
	{
		NI32 LOC34;
		if (!(result.Fhandle == ((NI) -1))) goto LA22;
		result.Mem = NIM_NIL;
		result.Size = ((NI) 0);
		{
			NI32 LOC28;
			if (!!((result.Fhandle == ((NI) 0)))) goto LA26;
			LOC28 = 0;
			LOC28 = Dl_103424(result.Fhandle);
		}
		LA26: ;
		{
			NI32 LOC33;
			if (!!((result.Maphandle == ((NI) 0)))) goto LA31;
			LOC33 = 0;
			LOC33 = Dl_103424(result.Maphandle);
		}
		LA31: ;
		LOC34 = 0;
		LOC34 = oslasterror_113454();
		raiseoserror_113430(LOC34);
	}
	LA22: ;
	{
		NI32 sizehigh;
		NI32 sizelow;
		NI32 status;
		NI32 lasterr;
		if (!!((newfilesize == ((NI) -1)))) goto LA37;
		sizehigh = ((NI32) ((NI)((NU64)(newfilesize) >> (NU64)(((NI) 32)))));
		sizelow = ((NI32) ((NI)(newfilesize & ((NI) IL64(4294967295)))));
		status = Dl_105410(result.Fhandle, sizelow, (&sizehigh), ((NI32) 0));
		lasterr = oslasterror_113454();
		{
			NIM_BOOL LOC41;
			NIM_BOOL LOC42;
			NI32 LOC45;
			LOC41 = 0;
			LOC42 = 0;
			LOC42 = (status == ((NI32) -1));
			if (!(LOC42)) goto LA43;
			LOC42 = !((lasterr == ((NI32) 0)));
			LA43: ;
			LOC41 = LOC42;
			if (LOC41) goto LA44;
			LOC45 = 0;
			LOC45 = Dl_105404(result.Fhandle);
			LOC41 = (LOC45 == ((NI32) 0));
			LA44: ;
			if (!LOC41) goto LA46;
			result.Mem = NIM_NIL;
			result.Size = ((NI) 0);
			{
				NI32 LOC52;
				if (!!((result.Fhandle == ((NI) 0)))) goto LA50;
				LOC52 = 0;
				LOC52 = Dl_103424(result.Fhandle);
			}
			LA50: ;
			{
				NI32 LOC57;
				if (!!((result.Maphandle == ((NI) 0)))) goto LA55;
				LOC57 = 0;
				LOC57 = Dl_103424(result.Maphandle);
			}
			LA55: ;
			raiseoserror_113430(lasterr);
		}
		LA46: ;
	}
	LA37: ;
	LOC58 = 0;
	{
		if (!readonly) goto LA61;
		LOC58 = ((NI32) 2);
	}
	goto LA59;
	LA61: ;
	{
		LOC58 = ((NI32) 4);
	}
	LA59: ;
	result.Maphandle = Dl_105439(result.Fhandle, NIM_NIL, LOC58, ((NI32) 0), ((NI32) 0), NIM_NIL);
	{
		NI32 LOC78;
		if (!(result.Maphandle == ((NI) 0))) goto LA66;
		result.Mem = NIM_NIL;
		result.Size = ((NI) 0);
		{
			NI32 LOC72;
			if (!!((result.Fhandle == ((NI) 0)))) goto LA70;
			LOC72 = 0;
			LOC72 = Dl_103424(result.Fhandle);
		}
		LA70: ;
		{
			NI32 LOC77;
			if (!!((result.Maphandle == ((NI) 0)))) goto LA75;
			LOC77 = 0;
			LOC77 = Dl_103424(result.Maphandle);
		}
		LA75: ;
		LOC78 = 0;
		LOC78 = oslasterror_113454();
		raiseoserror_113430(LOC78);
	}
	LA66: ;
	LOC79 = 0;
	{
		if (!readonly) goto LA82;
		LOC79 = ((NI32) 4);
	}
	goto LA80;
	LA82: ;
	{
		LOC79 = ((NI32) 2);
	}
	LA80: ;
	LOC85 = 0;
	{
		if (!(mappedsize == ((NI) -1))) goto LA88;
		LOC85 = ((NI) 0);
	}
	goto LA86;
	LA88: ;
	{
		LOC85 = mappedsize;
	}
	LA86: ;
	result.Mem = Dl_105428(result.Maphandle, LOC79, ((NI32) ((NI)((NU64)(offset) >> (NU64)(((NI) 32))))), ((NI32) ((NI)(offset & ((NI) IL64(4294967295))))), ((NI32) (LOC85)), NIM_NIL);
	{
		NI32 LOC105;
		if (!(result.Mem == NIM_NIL)) goto LA93;
		result.Mem = NIM_NIL;
		result.Size = ((NI) 0);
		{
			NI32 LOC99;
			if (!!((result.Fhandle == ((NI) 0)))) goto LA97;
			LOC99 = 0;
			LOC99 = Dl_103424(result.Fhandle);
		}
		LA97: ;
		{
			NI32 LOC104;
			if (!!((result.Maphandle == ((NI) 0)))) goto LA102;
			LOC104 = 0;
			LOC104 = Dl_103424(result.Maphandle);
		}
		LA102: ;
		LOC105 = 0;
		LOC105 = oslasterror_113454();
		raiseoserror_113430(LOC105);
	}
	LA93: ;
	hi = 0;
	low = 0;
	low = Dl_105420(result.Fhandle, (&hi));
	{
		NI32 LOC120;
		if (!(low == ((NI32) -1))) goto LA108;
		result.Mem = NIM_NIL;
		result.Size = ((NI) 0);
		{
			NI32 LOC114;
			if (!!((result.Fhandle == ((NI) 0)))) goto LA112;
			LOC114 = 0;
			LOC114 = Dl_103424(result.Fhandle);
		}
		LA112: ;
		{
			NI32 LOC119;
			if (!!((result.Maphandle == ((NI) 0)))) goto LA117;
			LOC119 = 0;
			LOC119 = Dl_103424(result.Maphandle);
		}
		LA117: ;
		LOC120 = 0;
		LOC120 = oslasterror_113454();
		raiseoserror_113430(LOC120);
	}
	goto LA106;
	LA108: ;
	{
		NI64 filesize;
		filesize = (NI64)((NI64)((NU64)(((NI64) (hi))) >> (NU64)(IL64(32))) | ((NI64) (low)));
		{
			if (!!((mappedsize == ((NI) -1)))) goto LA124;
			result.Size = ((NI) (((filesize <= ((NI64) (mappedsize))) ? filesize : ((NI64) (mappedsize)))));
		}
		goto LA122;
		LA124: ;
		{
			result.Size = ((NI) (filesize));
		}
		LA122: ;
	}
	LA106: ;
	return result;
}

N_NIMCALL(void, close_249229)(memfile248208* f) {
	NIM_BOOL error;
	NI32 lasterr;
	error = NIM_FALSE;
	lasterr = 0;
	{
		NI32 LOC5;
		NIM_BOOL LOC6;
		NI32 LOC7;
		NIM_BOOL LOC9;
		NI32 LOC10;
		if (!!(((*f).Fhandle == ((NI) -1)))) goto LA3;
		LOC5 = 0;
		LOC5 = Dl_105601((*f).Mem);
		error = (LOC5 == ((NI32) 0));
		lasterr = oslasterror_113454();
		LOC6 = 0;
		LOC7 = 0;
		LOC7 = Dl_103424((*f).Maphandle);
		LOC6 = (LOC7 == ((NI32) 0));
		if (LOC6) goto LA8;
		LOC6 = error;
		LA8: ;
		error = LOC6;
		LOC9 = 0;
		LOC10 = 0;
		LOC10 = Dl_103424((*f).Fhandle);
		LOC9 = (LOC10 == ((NI32) 0));
		if (LOC9) goto LA11;
		LOC9 = error;
		LA11: ;
		error = LOC9;
	}
	LA3: ;
	(*f).Size = ((NI) 0);
	(*f).Mem = NIM_NIL;
	(*f).Fhandle = ((NI) 0);
	(*f).Maphandle = ((NI) 0);
	{
		if (!error) goto LA14;
		raiseoserror_113430(lasterr);
	}
	LA14: ;
}
NIM_EXTERNC N_NOINLINE(void, stdlib_memfilesInit)(void) {
}

NIM_EXTERNC N_NOINLINE(void, stdlib_memfilesDatInit)(void) {
static TNimNode* TMP833[4];
static TNimNode TMP817[5];
NTI248208.size = sizeof(memfile248208);
NTI248208.kind = 18;
NTI248208.base = 0;
NTI248208.flags = 3;
TMP833[0] = &TMP817[1];
TMP817[1].kind = 1;
TMP817[1].offset = offsetof(memfile248208, Mem);
TMP817[1].typ = (&NTI153);
TMP817[1].name = "mem";
TMP833[1] = &TMP817[2];
TMP817[2].kind = 1;
TMP817[2].offset = offsetof(memfile248208, Size);
TMP817[2].typ = (&NTI108);
TMP817[2].name = "size";
TMP833[2] = &TMP817[3];
TMP817[3].kind = 1;
TMP817[3].offset = offsetof(memfile248208, Fhandle);
TMP817[3].typ = (&NTI108);
TMP817[3].name = "fHandle";
TMP833[3] = &TMP817[4];
TMP817[4].kind = 1;
TMP817[4].offset = offsetof(memfile248208, Maphandle);
TMP817[4].typ = (&NTI108);
TMP817[4].name = "mapHandle";
TMP817[0].len = 4; TMP817[0].kind = 2; TMP817[0].sons = &TMP833[0];
NTI248208.node = &TMP817[0];
}

