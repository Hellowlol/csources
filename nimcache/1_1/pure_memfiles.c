/* Generated by Nimrod Compiler v0.9.3 */
/*   (c) 2012 Andreas Rumpf */
/* The generated code is subject to the original license. */
#define NIM_INTBITS 32
#include "nimbase.h"

#include <string.h>
typedef struct tmemfile211204 tmemfile211204;
typedef struct NimStringDesc NimStringDesc;
typedef struct TGenericSeq TGenericSeq;
typedef struct TNimType TNimType;
typedef struct TNimNode TNimNode;
struct tmemfile211204 {
void* Mem;
NI Size;
NI Fhandle;
NI Maphandle;
};
struct TGenericSeq {
NI len;
NI reserved;
};
typedef NIM_CHAR TY611[100000001];
struct NimStringDesc {
  TGenericSeq Sup;
TY611 data;
};
typedef N_STDCALL_PTR(NI, TY91407) (NI16* lpfilename, NI32 dwdesiredaccess, NI32 dwsharemode, void* lpsecurityattributes, NI32 dwcreationdisposition, NI32 dwflagsandattributes, NI htemplatefile);
typedef N_STDCALL_PTR(NI32, TY89821) (NI hobject);
typedef N_STDCALL_PTR(NI32, TY91607) (NI hfile, NI32 ldistancetomove, NI32* lpdistancetomovehigh, NI32 dwmovemethod);
typedef N_STDCALL_PTR(NI32, TY91603) (NI hfile);
typedef N_STDCALL_PTR(NI, TY91630) (NI hfile, void* lpfilemappingattributes, NI32 flprotect, NI32 dwmaximumsizehigh, NI32 dwmaximumsizelow, void* lpname);
typedef N_STDCALL_PTR(void*, TY91621) (NI hfilemappingobject, NI32 dwdesiredaccess, NI32 dwfileoffsethigh, NI32 dwfileoffsetlow, NI32 dwnumberofbytestomap, void* lpbaseaddress);
typedef N_STDCALL_PTR(NI32, TY91615) (NI hfile, NI32* lpfilesizehigh);
typedef N_STDCALL_PTR(NI32, TY91802) (void* lpbaseaddress);
typedef N_NIMCALL_PTR(void, TY889) (void* p, NI op);
struct TNimType {
NI size;
NU8 kind;
NU8 flags;
TNimType* base;
TNimNode* node;
void* finalizer;
TY889 marker;
};
struct TNimNode {
NU8 kind;
NI offset;
TNimType* typ;
NCSTRING name;
NI len;
TNimNode** sons;
};
N_NIMCALL(tmemfile211204, open_211211)(NimStringDesc* filename, NU8 mode, NI mappedsize, NI offset, NI newfilesize);
N_NIMCALL(void, hiddenraiseassert_77217)(NimStringDesc* msg);
N_NIMCALL(NI16*, newwidecstring_70603)(NimStringDesc* s);
N_NIMCALL(void, oserror_97226)(NI32 errorcode);
N_NIMCALL(NI32, oslasterror_97267)(void);
static N_INLINE(NI, chckRange)(NI i, NI a, NI b);
N_NOINLINE(void, raiseRangeError)(NI64 val);
N_NIMCALL(NI64, chckRange64)(NI64 i, NI64 a, NI64 b);
static N_INLINE(void, nimFrame)(TFrame* s);
static N_INLINE(void, popFrame)(void);
N_NIMCALL(void, close_211823)(tmemfile211204* f);
STRING_LITERAL(TMP2859, "newFileSize == -1 or not (mode == fmRead) ", 42);
extern TY91407 Dl_91406;
extern TY89821 Dl_89820;
extern TY91607 Dl_91606;
extern TY91603 Dl_91602;
extern TY91630 Dl_91629;
extern TY91621 Dl_91620;
extern TY91615 Dl_91614;
extern TFrame* frameptr_12037;
extern TY91802 Dl_91801;
TNimType NTI211204; /* TMemFile */
extern TNimType NTI146; /* pointer */
extern TNimType NTI105; /* int */

static N_INLINE(NI, chckRange)(NI i, NI a, NI b) {
	NI result;
	result = 0;
	{
		NIM_BOOL LOC3;
		LOC3 = 0;
		LOC3 = (a <= i);
		if (!(LOC3)) goto LA4;
		LOC3 = (i <= b);
		LA4: ;
		if (!LOC3) goto LA5;
		result = i;
		goto BeforeRet;
	}	goto LA1;
	LA5: ;
	{
		raiseRangeError(((NI64) (i)));	}	LA1: ;
	BeforeRet: ;	return result;
}
static N_INLINE(void, nimFrame)(TFrame* s) {
	(*s).prev = frameptr_12037;
	frameptr_12037 = s;
}
static N_INLINE(void, popFrame)(void) {
	frameptr_12037 = (*frameptr_12037).prev;
}
N_NIMCALL(tmemfile211204, open_211211)(NimStringDesc* filename, NU8 mode, NI mappedsize, NI offset, NI newfilesize) {
	tmemfile211204 result;
	NIM_BOOL readonly;
	NI16* LOC7;
	NI32 LOC8;
	NI32 LOC14;
	NI32 LOC20;
	NI32 LOC64;
	NI32 LOC85;
	NI LOC91;
	NI32 hi;
	NI32 low;
	nimfr("open", "memfiles.nim")
	memset((void*)&result, 0, sizeof(result));
	nimln(45, "memfiles.nim");
	{
		NIM_BOOL LOC3;
		nimln(45, "memfiles.nim");
		nimln(45, "memfiles.nim");
		LOC3 = 0;
		nimln(45, "memfiles.nim");
		LOC3 = (newfilesize == -1);
		if (LOC3) goto LA4;
		nimln(45, "memfiles.nim");
		nimln(45, "memfiles.nim");
		LOC3 = !((mode == ((NU8) 0)));
		LA4: ;
		if (!!(LOC3)) goto LA5;
		nimln(45, "memfiles.nim");
		hiddenraiseassert_77217(((NimStringDesc*) &TMP2859));	}	LA5: ;
	nimln(46, "memfiles.nim");
	nimln(46, "memfiles.nim");
	readonly = (mode == ((NU8) 0));
	nimln(72, "memfiles.nim");
	nimln(72, "memfiles.nim");
	LOC7 = 0;
	LOC7 = newwidecstring_70603(filename);
	LOC8 = 0;
	nimln(64, "memfiles.nim");
	{
		if (!readonly) goto LA11;
		LOC8 = ((NI32) (-2147483647 -1));
	}	goto LA9;
	LA11: ;
	{
		LOC8 = ((NI32) 268435456);
	}	LA9: ;
	LOC14 = 0;
	nimln(67, "memfiles.nim");
	{
		nimln(698, "system.nim");
		nimln(698, "system.nim");
		if (!!((newfilesize == -1))) goto LA17;
		LOC14 = ((NI32) 2);
	}	goto LA15;
	LA17: ;
	{
		LOC14 = ((NI32) 3);
	}	LA15: ;
	LOC20 = 0;
	nimln(68, "memfiles.nim");
	{
		if (!readonly) goto LA23;
		LOC20 = ((NI32) 1);
	}	goto LA21;
	LA23: ;
	{
		LOC20 = ((NI32) 256);
	}	LA21: ;
	result.Fhandle = Dl_91406(LOC7, LOC8, ((NI32) 1), NIM_NIL, LOC14, LOC20, 0);
	nimln(76, "memfiles.nim");
	{
		NI32 LOC40;
		nimln(76, "memfiles.nim");
		if (!(result.Fhandle == -1)) goto LA28;
		nimln(49, "memfiles.nim");
		result.Mem = NIM_NIL;
		nimln(50, "memfiles.nim");
		result.Size = 0;
		nimln(55, "memfiles.nim");
		{
			NI32 LOC34;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((result.Fhandle == 0))) goto LA32;
			nimln(55, "memfiles.nim");
			nimln(55, "memfiles.nim");
			LOC34 = 0;
			LOC34 = Dl_89820(result.Fhandle);
		}		LA32: ;
		nimln(56, "memfiles.nim");
		{
			NI32 LOC39;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((result.Maphandle == 0))) goto LA37;
			nimln(56, "memfiles.nim");
			nimln(56, "memfiles.nim");
			LOC39 = 0;
			LOC39 = Dl_89820(result.Maphandle);
		}		LA37: ;
		nimln(57, "memfiles.nim");
		nimln(77, "memfiles.nim");
		LOC40 = 0;
		LOC40 = oslasterror_97267();
		oserror_97226(LOC40);	}	LA28: ;
	nimln(79, "memfiles.nim");
	{
		NI32 sizehigh;
		NI32 sizelow;
		NI32 status;
		NI32 lasterr;
		nimln(698, "system.nim");
		nimln(698, "system.nim");
		if (!!((newfilesize == -1))) goto LA43;
		nimln(81, "memfiles.nim");
		nimln(81, "memfiles.nim");
		sizehigh = ((NI32) ((NI)((NU32)(newfilesize) >> (NU32)(32))));
		nimln(82, "memfiles.nim");
		nimln(82, "memfiles.nim");
		sizelow = ((NI32)chckRange((NI)(((NI64) (newfilesize)) & IL64(4294967295)), ((NI32) (-2147483647 -1)), ((NI32) 2147483647)));
		nimln(84, "memfiles.nim");
		status = Dl_91606(result.Fhandle, sizelow, &sizehigh, ((NI32) 0));
		nimln(86, "memfiles.nim");
		lasterr = oslasterror_97267();
		nimln(87, "memfiles.nim");
		{
			NIM_BOOL LOC47;
			NIM_BOOL LOC48;
			NI32 LOC51;
			nimln(87, "memfiles.nim");
			LOC47 = 0;
			nimln(87, "memfiles.nim");
			LOC48 = 0;
			nimln(87, "memfiles.nim");
			LOC48 = (status == ((NI32) -1));
			if (!(LOC48)) goto LA49;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			LOC48 = !((lasterr == ((NI32) 0)));
			LA49: ;
			LOC47 = LOC48;
			if (LOC47) goto LA50;
			nimln(88, "memfiles.nim");
			nimln(88, "memfiles.nim");
			LOC51 = 0;
			LOC51 = Dl_91602(result.Fhandle);
			LOC47 = (LOC51 == ((NI32) 0));
			LA50: ;
			if (!LOC47) goto LA52;
			nimln(49, "memfiles.nim");
			result.Mem = NIM_NIL;
			nimln(50, "memfiles.nim");
			result.Size = 0;
			nimln(55, "memfiles.nim");
			{
				NI32 LOC58;
				nimln(698, "system.nim");
				nimln(698, "system.nim");
				if (!!((result.Fhandle == 0))) goto LA56;
				nimln(55, "memfiles.nim");
				nimln(55, "memfiles.nim");
				LOC58 = 0;
				LOC58 = Dl_89820(result.Fhandle);
			}			LA56: ;
			nimln(56, "memfiles.nim");
			{
				NI32 LOC63;
				nimln(698, "system.nim");
				nimln(698, "system.nim");
				if (!!((result.Maphandle == 0))) goto LA61;
				nimln(56, "memfiles.nim");
				nimln(56, "memfiles.nim");
				LOC63 = 0;
				LOC63 = Dl_89820(result.Maphandle);
			}			LA61: ;
			nimln(57, "memfiles.nim");
			oserror_97226(lasterr);		}		LA52: ;
	}	LA43: ;
	nimln(93, "memfiles.nim");
	LOC64 = 0;
	nimln(95, "memfiles.nim");
	{
		if (!readonly) goto LA67;
		LOC64 = ((NI32) 2);
	}	goto LA65;
	LA67: ;
	{
		LOC64 = ((NI32) 4);
	}	LA65: ;
	result.Maphandle = Dl_91629(result.Fhandle, NIM_NIL, LOC64, ((NI32) 0), ((NI32) 0), NIM_NIL);
	nimln(98, "memfiles.nim");
	{
		NI32 LOC84;
		nimln(98, "memfiles.nim");
		if (!(result.Maphandle == 0)) goto LA72;
		nimln(49, "memfiles.nim");
		result.Mem = NIM_NIL;
		nimln(50, "memfiles.nim");
		result.Size = 0;
		nimln(55, "memfiles.nim");
		{
			NI32 LOC78;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((result.Fhandle == 0))) goto LA76;
			nimln(55, "memfiles.nim");
			nimln(55, "memfiles.nim");
			LOC78 = 0;
			LOC78 = Dl_89820(result.Fhandle);
		}		LA76: ;
		nimln(56, "memfiles.nim");
		{
			NI32 LOC83;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((result.Maphandle == 0))) goto LA81;
			nimln(56, "memfiles.nim");
			nimln(56, "memfiles.nim");
			LOC83 = 0;
			LOC83 = Dl_89820(result.Maphandle);
		}		LA81: ;
		nimln(57, "memfiles.nim");
		nimln(99, "memfiles.nim");
		LOC84 = 0;
		LOC84 = oslasterror_97267();
		oserror_97226(LOC84);	}	LA72: ;
	nimln(101, "memfiles.nim");
	LOC85 = 0;
	nimln(103, "memfiles.nim");
	{
		if (!readonly) goto LA88;
		LOC85 = ((NI32) 4);
	}	goto LA86;
	LA88: ;
	{
		LOC85 = ((NI32) 2);
	}	LA86: ;
	nimln(104, "memfiles.nim");
	nimln(105, "memfiles.nim");
	LOC91 = 0;
	nimln(106, "memfiles.nim");
	{
		nimln(106, "memfiles.nim");
		if (!(mappedsize == -1)) goto LA94;
		LOC91 = 0;
	}	goto LA92;
	LA94: ;
	{
		LOC91 = mappedsize;
	}	LA92: ;
	result.Mem = Dl_91620(result.Maphandle, LOC85, ((NI32) ((NI)((NU32)(offset) >> (NU32)(32)))), ((NI32)chckRange((NI)(((NI64) (offset)) & IL64(4294967295)), ((NI32) (-2147483647 -1)), ((NI32) 2147483647))), ((NI32) (LOC91)), NIM_NIL);
	nimln(109, "memfiles.nim");
	{
		NI32 LOC111;
		nimln(109, "memfiles.nim");
		if (!(result.Mem == NIM_NIL)) goto LA99;
		nimln(49, "memfiles.nim");
		result.Mem = NIM_NIL;
		nimln(50, "memfiles.nim");
		result.Size = 0;
		nimln(55, "memfiles.nim");
		{
			NI32 LOC105;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((result.Fhandle == 0))) goto LA103;
			nimln(55, "memfiles.nim");
			nimln(55, "memfiles.nim");
			LOC105 = 0;
			LOC105 = Dl_89820(result.Fhandle);
		}		LA103: ;
		nimln(56, "memfiles.nim");
		{
			NI32 LOC110;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((result.Maphandle == 0))) goto LA108;
			nimln(56, "memfiles.nim");
			nimln(56, "memfiles.nim");
			LOC110 = 0;
			LOC110 = Dl_89820(result.Maphandle);
		}		LA108: ;
		nimln(57, "memfiles.nim");
		nimln(110, "memfiles.nim");
		LOC111 = 0;
		LOC111 = oslasterror_97267();
		oserror_97226(LOC111);	}	LA99: ;
	hi = 0;
	low = 0;
	nimln(113, "memfiles.nim");
	low = Dl_91614(result.Fhandle, &hi);
	nimln(114, "memfiles.nim");
	{
		NI32 LOC126;
		nimln(114, "memfiles.nim");
		if (!(low == ((NI32) -1))) goto LA114;
		nimln(49, "memfiles.nim");
		result.Mem = NIM_NIL;
		nimln(50, "memfiles.nim");
		result.Size = 0;
		nimln(55, "memfiles.nim");
		{
			NI32 LOC120;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((result.Fhandle == 0))) goto LA118;
			nimln(55, "memfiles.nim");
			nimln(55, "memfiles.nim");
			LOC120 = 0;
			LOC120 = Dl_89820(result.Fhandle);
		}		LA118: ;
		nimln(56, "memfiles.nim");
		{
			NI32 LOC125;
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((result.Maphandle == 0))) goto LA123;
			nimln(56, "memfiles.nim");
			nimln(56, "memfiles.nim");
			LOC125 = 0;
			LOC125 = Dl_89820(result.Maphandle);
		}		LA123: ;
		nimln(57, "memfiles.nim");
		nimln(115, "memfiles.nim");
		LOC126 = 0;
		LOC126 = oslasterror_97267();
		oserror_97226(LOC126);	}	goto LA112;
	LA114: ;
	{
		NI64 filesize;
		nimln(117, "memfiles.nim");
		nimln(117, "memfiles.nim");
		nimln(117, "memfiles.nim");
		filesize = (NI64)((NI64)((NU64)(((NI64) (hi))) >> (NU64)(32)) | ((NI64) (low)));
		nimln(118, "memfiles.nim");
		{
			nimln(698, "system.nim");
			nimln(698, "system.nim");
			if (!!((mappedsize == -1))) goto LA130;
			nimln(118, "memfiles.nim");
			nimln(118, "memfiles.nim");
			result.Size = ((NI)chckRange64(((filesize <= ((NI64) (mappedsize))) ? filesize : ((NI64) (mappedsize))), (-2147483647 -1), 2147483647));
		}		goto LA128;
		LA130: ;
		{
			nimln(119, "memfiles.nim");
			result.Size = ((NI)chckRange64(filesize, (-2147483647 -1), 2147483647));
		}		LA128: ;
	}	LA112: ;
	popFrame();
	return result;
}
N_NIMCALL(void, close_211823)(tmemfile211204* f) {
	NIM_BOOL error;
	NI32 lasterr;
	nimfr("close", "memfiles.nim")
	nimln(168, "memfiles.nim");
	error = NIM_FALSE;
	lasterr = 0;
	nimln(172, "memfiles.nim");
	{
		NI32 LOC5;
		NIM_BOOL LOC6;
		NI32 LOC7;
		NIM_BOOL LOC9;
		NI32 LOC10;
		nimln(698, "system.nim");
		nimln(698, "system.nim");
		if (!!(((*f).Fhandle == -1))) goto LA3;
		nimln(173, "memfiles.nim");
		lasterr = oslasterror_97267();
		nimln(174, "memfiles.nim");
		nimln(174, "memfiles.nim");
		nimln(174, "memfiles.nim");
		LOC5 = 0;
		LOC5 = Dl_91801((*f).Mem);
		error = (LOC5 == ((NI32) 0));
		nimln(175, "memfiles.nim");
		nimln(175, "memfiles.nim");
		LOC6 = 0;
		nimln(175, "memfiles.nim");
		nimln(175, "memfiles.nim");
		LOC7 = 0;
		LOC7 = Dl_89820((*f).Maphandle);
		LOC6 = (LOC7 == ((NI32) 0));
		if (LOC6) goto LA8;
		LOC6 = error;
		LA8: ;
		error = LOC6;
		nimln(176, "memfiles.nim");
		nimln(176, "memfiles.nim");
		LOC9 = 0;
		nimln(176, "memfiles.nim");
		nimln(176, "memfiles.nim");
		LOC10 = 0;
		LOC10 = Dl_89820((*f).Fhandle);
		LOC9 = (LOC10 == ((NI32) 0));
		if (LOC9) goto LA11;
		LOC9 = error;
		LA11: ;
		error = LOC9;
	}	LA3: ;
	nimln(183, "memfiles.nim");
	(*f).Size = 0;
	nimln(184, "memfiles.nim");
	(*f).Mem = NIM_NIL;
	nimln(187, "memfiles.nim");
	(*f).Fhandle = 0;
	nimln(188, "memfiles.nim");
	(*f).Maphandle = 0;
	nimln(192, "memfiles.nim");
	{
		if (!error) goto LA14;
		nimln(192, "memfiles.nim");
		oserror_97226(lasterr);	}	LA14: ;
	popFrame();
}N_NOINLINE(void, purememfilesInit)(void) {
	nimfr("memfiles", "memfiles.nim")
	popFrame();
}

N_NOINLINE(void, purememfilesDatInit)(void) {
static TNimNode* TMP2940[4];
static TNimNode TMP2857[5];
NTI211204.size = sizeof(tmemfile211204);
NTI211204.kind = 18;
NTI211204.base = 0;
NTI211204.flags = 3;
TMP2940[0] = &TMP2857[1];
TMP2857[1].kind = 1;
TMP2857[1].offset = offsetof(tmemfile211204, Mem);
TMP2857[1].typ = (&NTI146);
TMP2857[1].name = "mem";
TMP2940[1] = &TMP2857[2];
TMP2857[2].kind = 1;
TMP2857[2].offset = offsetof(tmemfile211204, Size);
TMP2857[2].typ = (&NTI105);
TMP2857[2].name = "size";
TMP2940[2] = &TMP2857[3];
TMP2857[3].kind = 1;
TMP2857[3].offset = offsetof(tmemfile211204, Fhandle);
TMP2857[3].typ = (&NTI105);
TMP2857[3].name = "fHandle";
TMP2940[3] = &TMP2857[4];
TMP2857[4].kind = 1;
TMP2857[4].offset = offsetof(tmemfile211204, Maphandle);
TMP2857[4].typ = (&NTI105);
TMP2857[4].name = "mapHandle";
TMP2857[0].len = 4; TMP2857[0].kind = 2; TMP2857[0].sons = &TMP2940[0];
NTI211204.node = &TMP2857[0];
}

