/* Generated by Nim Compiler v0.17.0 */
/*   (c) 2017 Andreas Rumpf */
/* The generated code is subject to the original license. */
#define NIM_NEW_MANGLING_RULES
#define NIM_INTBITS 32

#include "nimbase.h"
#include <string.h>
#undef linux
#undef near
typedef struct MemFile_j4SnXNrJDFBxAz4BlbM9aIQ MemFile_j4SnXNrJDFBxAz4BlbM9aIQ;
typedef struct TNimType TNimType;
typedef struct TNimNode TNimNode;
typedef struct NimStringDesc NimStringDesc;
typedef struct TGenericSeq TGenericSeq;
struct  MemFile_j4SnXNrJDFBxAz4BlbM9aIQ  {
void* mem;
NI size;
NI fHandle;
NI mapHandle;
NIM_BOOL wasOpened;
};
typedef NU8 TNimKind_jIBKr1ejBgsfM33Kxw4j7A;
typedef NU8 TNimTypeFlag_v8QUszD1sWlSIWZz7mC4bQ_Set;
typedef N_NIMCALL_PTR(void, TY_ojoeKfW4VYIm36I9cpDTQIg) (void* p, NI op);
typedef N_NIMCALL_PTR(void*, TY_WSm2xU5ARYv9aAR4l0z9c9auQ) (void* p);
struct  TNimType  {
NI size;
TNimKind_jIBKr1ejBgsfM33Kxw4j7A kind;
TNimTypeFlag_v8QUszD1sWlSIWZz7mC4bQ_Set flags;
TNimType* base;
TNimNode* node;
void* finalizer;
TY_ojoeKfW4VYIm36I9cpDTQIg marker;
TY_WSm2xU5ARYv9aAR4l0z9c9auQ deepcopy;
};
typedef NU8 TNimNodeKind_unfNsxrcATrufDZmpBq4HQ;
struct  TNimNode  {
TNimNodeKind_unfNsxrcATrufDZmpBq4HQ kind;
NI offset;
TNimType* typ;
NCSTRING name;
NI len;
TNimNode** sons;
};
struct  TGenericSeq  {
NI len;
NI reserved;
};
struct  NimStringDesc  {
  TGenericSeq Sup;
NIM_CHAR data[SEQ_DECL_SIZE];
};
typedef NU8 FileMode_fVUBHvW79bXUw1j55Oo9avSQ;
typedef N_STDCALL_PTR(NI, TY_jZjaRJIBSgYA1p8iXwsy9cA) (NI16* lpFileName, NI32 dwDesiredAccess, NI32 dwShareMode, void* lpSecurityAttributes, NI32 dwCreationDisposition, NI32 dwFlagsAndAttributes, NI hTemplateFile);
typedef N_STDCALL_PTR(NI32, TY_P13srMBg9b3d3yEV9aW4NCoA) (NI hObject);
typedef N_STDCALL_PTR(NI32, TY_ZF830CPGZda8saokdzv3Nw) (NI hFile, NI32 lDistanceToMove, NI32* lpDistanceToMoveHigh, NI32 dwMoveMethod);
typedef N_STDCALL_PTR(NI, TY_rQv4HdT3JZB1EnhSb4r4Gg) (NI hFile, void* lpFileMappingAttributes, NI32 flProtect, NI32 dwMaximumSizeHigh, NI32 dwMaximumSizeLow, void* lpName);
typedef N_STDCALL_PTR(void*, TY_N3uS69bw8S7evCEnH5Rc6Mg) (NI hFileMappingObject, NI32 dwDesiredAccess, NI32 dwFileOffsetHigh, NI32 dwFileOffsetLow, NI32 dwNumberOfBytesToMap, void* lpBaseAddress);
typedef N_STDCALL_PTR(NI32, TY_I8CYTKrqz0DV8EyysIRhJw) (NI hFile, NI32* lpFileSizeHigh);
typedef N_STDCALL_PTR(NI32, TY_ah5wcFv3UG20t2vgXBy0Fg) (void* lpBaseAddress);
N_NIMCALL(NI16*, newWideCString_kxipuF9cNh6r2grKDcLjFuw)(NimStringDesc* s);
N_NOINLINE(void, raiseOSError_86HIIOlD5N61CWaO5GBgqA)(NI32 errorCode, NimStringDesc* additionalInfo);
N_NIMCALL(NI32, osLastError_ZQxqnPZsO7WoZx9aX9a5a9cfQ)(void);
TNimType NTI_j4SnXNrJDFBxAz4BlbM9aIQ_;
extern TNimType NTI_vr5DoT1jILTGdRlYv1OYpw_;
extern TNimType NTI_rR5Bzr1D5krxoo1NcNyeMA_;
extern TNimType NTI_VaVACK0bpYmqIQ0mKcHfQQ_;
extern TY_jZjaRJIBSgYA1p8iXwsy9cA Dl_129423_;
extern TY_P13srMBg9b3d3yEV9aW4NCoA Dl_127603_;
extern TY_ZF830CPGZda8saokdzv3Nw Dl_129604_;
extern TY_P13srMBg9b3d3yEV9aW4NCoA Dl_129601_;
extern TY_rQv4HdT3JZB1EnhSb4r4Gg Dl_129624_;
extern TY_N3uS69bw8S7evCEnH5Rc6Mg Dl_129616_;
extern TY_I8CYTKrqz0DV8EyysIRhJw Dl_129611_;
extern TY_ah5wcFv3UG20t2vgXBy0Fg Dl_129801_;
STRING_LITERAL(TM_mFfhe8Jm7Jqn2Znr3841fw_3, "", 0);

N_NIMCALL(MemFile_j4SnXNrJDFBxAz4BlbM9aIQ, open_39cFdhV3oLaZ6GpD2Bd26ew)(NimStringDesc* filename, FileMode_fVUBHvW79bXUw1j55Oo9avSQ mode, NI mappedSize, NI offset, NI newFileSize, NIM_BOOL allowRemap) {
	MemFile_j4SnXNrJDFBxAz4BlbM9aIQ result;
	NIM_BOOL readonly;
	NI16* T1_;
	NI32 T2_;
	NI32 T8_;
	NI32 T14_;
	NI32 T58_;
	NI32 T79_;
	NI T85_;
	NI32 hi;
	NI32 low;
	memset((void*)(&result), 0, sizeof(result));
	readonly = (mode == ((FileMode_fVUBHvW79bXUw1j55Oo9avSQ) 0));
	T1_ = (NI16*)0;
	T1_ = newWideCString_kxipuF9cNh6r2grKDcLjFuw(filename);
	T2_ = (NI32)0;
	{
		if (!readonly) goto LA5_;
		T2_ = ((NI32) (-2147483647 -1));
	}
	goto LA3_;
	LA5_: ;
	{
		T2_ = ((NI32) -1073741824);
	}
	LA3_: ;
	T8_ = (NI32)0;
	{
		if (!!((newFileSize == ((NI) -1)))) goto LA11_;
		T8_ = ((NI32) 2);
	}
	goto LA9_;
	LA11_: ;
	{
		T8_ = ((NI32) 3);
	}
	LA9_: ;
	T14_ = (NI32)0;
	{
		if (!readonly) goto LA17_;
		T14_ = ((NI32) 1);
	}
	goto LA15_;
	LA17_: ;
	{
		T14_ = ((NI32) 256);
	}
	LA15_: ;
	result.fHandle = Dl_129423_(T1_, T2_, ((NI32) 1), NIM_NIL, T8_, T14_, ((NI) 0));
	{
		NI32 T34_;
		if (!(result.fHandle == ((NI) -1))) goto LA22_;
		result.mem = NIM_NIL;
		result.size = ((NI) 0);
		{
			NI32 T28_;
			if (!!((result.fHandle == ((NI) 0)))) goto LA26_;
			T28_ = (NI32)0;
			T28_ = Dl_127603_(result.fHandle);
		}
		LA26_: ;
		{
			NI32 T33_;
			if (!!((result.mapHandle == ((NI) 0)))) goto LA31_;
			T33_ = (NI32)0;
			T33_ = Dl_127603_(result.mapHandle);
		}
		LA31_: ;
		T34_ = (NI32)0;
		T34_ = osLastError_ZQxqnPZsO7WoZx9aX9a5a9cfQ();
		raiseOSError_86HIIOlD5N61CWaO5GBgqA(T34_, ((NimStringDesc*) &TM_mFfhe8Jm7Jqn2Znr3841fw_3));
	}
	LA22_: ;
	{
		NI32 sizeHigh;
		NI32 sizeLow;
		NI32 status;
		NI32 lastErr;
		if (!!((newFileSize == ((NI) -1)))) goto LA37_;
		sizeHigh = ((NI32) ((NI)((NU32)(newFileSize) >> (NU32)(((NI) 32)))));
		sizeLow = ((NI32) ((NI64)(((NI64) (newFileSize)) & IL64(4294967295))));
		status = Dl_129604_(result.fHandle, sizeLow, (&sizeHigh), ((NI32) 0));
		lastErr = osLastError_ZQxqnPZsO7WoZx9aX9a5a9cfQ();
		{
			NIM_BOOL T41_;
			NIM_BOOL T42_;
			NI32 T45_;
			T41_ = (NIM_BOOL)0;
			T42_ = (NIM_BOOL)0;
			T42_ = (status == ((NI32) -1));
			if (!(T42_)) goto LA43_;
			T42_ = !((lastErr == ((NI32) 0)));
			LA43_: ;
			T41_ = T42_;
			if (T41_) goto LA44_;
			T45_ = (NI32)0;
			T45_ = Dl_129601_(result.fHandle);
			T41_ = (T45_ == ((NI32) 0));
			LA44_: ;
			if (!T41_) goto LA46_;
			result.mem = NIM_NIL;
			result.size = ((NI) 0);
			{
				NI32 T52_;
				if (!!((result.fHandle == ((NI) 0)))) goto LA50_;
				T52_ = (NI32)0;
				T52_ = Dl_127603_(result.fHandle);
			}
			LA50_: ;
			{
				NI32 T57_;
				if (!!((result.mapHandle == ((NI) 0)))) goto LA55_;
				T57_ = (NI32)0;
				T57_ = Dl_127603_(result.mapHandle);
			}
			LA55_: ;
			raiseOSError_86HIIOlD5N61CWaO5GBgqA(lastErr, ((NimStringDesc*) &TM_mFfhe8Jm7Jqn2Znr3841fw_3));
		}
		LA46_: ;
	}
	LA37_: ;
	T58_ = (NI32)0;
	{
		if (!readonly) goto LA61_;
		T58_ = ((NI32) 2);
	}
	goto LA59_;
	LA61_: ;
	{
		T58_ = ((NI32) 4);
	}
	LA59_: ;
	result.mapHandle = Dl_129624_(result.fHandle, NIM_NIL, T58_, ((NI32) 0), ((NI32) 0), NIM_NIL);
	{
		NI32 T78_;
		if (!(result.mapHandle == ((NI) 0))) goto LA66_;
		result.mem = NIM_NIL;
		result.size = ((NI) 0);
		{
			NI32 T72_;
			if (!!((result.fHandle == ((NI) 0)))) goto LA70_;
			T72_ = (NI32)0;
			T72_ = Dl_127603_(result.fHandle);
		}
		LA70_: ;
		{
			NI32 T77_;
			if (!!((result.mapHandle == ((NI) 0)))) goto LA75_;
			T77_ = (NI32)0;
			T77_ = Dl_127603_(result.mapHandle);
		}
		LA75_: ;
		T78_ = (NI32)0;
		T78_ = osLastError_ZQxqnPZsO7WoZx9aX9a5a9cfQ();
		raiseOSError_86HIIOlD5N61CWaO5GBgqA(T78_, ((NimStringDesc*) &TM_mFfhe8Jm7Jqn2Znr3841fw_3));
	}
	LA66_: ;
	T79_ = (NI32)0;
	{
		if (!readonly) goto LA82_;
		T79_ = ((NI32) 4);
	}
	goto LA80_;
	LA82_: ;
	{
		T79_ = ((NI32) 2);
	}
	LA80_: ;
	T85_ = (NI)0;
	{
		if (!(mappedSize == ((NI) -1))) goto LA88_;
		T85_ = ((NI) 0);
	}
	goto LA86_;
	LA88_: ;
	{
		T85_ = mappedSize;
	}
	LA86_: ;
	result.mem = Dl_129616_(result.mapHandle, T79_, ((NI32) ((NI)((NU32)(offset) >> (NU32)(((NI) 32))))), ((NI32) ((NI64)(((NI64) (offset)) & IL64(4294967295)))), ((NI32) (T85_)), NIM_NIL);
	{
		NI32 T105_;
		if (!(result.mem == NIM_NIL)) goto LA93_;
		result.mem = NIM_NIL;
		result.size = ((NI) 0);
		{
			NI32 T99_;
			if (!!((result.fHandle == ((NI) 0)))) goto LA97_;
			T99_ = (NI32)0;
			T99_ = Dl_127603_(result.fHandle);
		}
		LA97_: ;
		{
			NI32 T104_;
			if (!!((result.mapHandle == ((NI) 0)))) goto LA102_;
			T104_ = (NI32)0;
			T104_ = Dl_127603_(result.mapHandle);
		}
		LA102_: ;
		T105_ = (NI32)0;
		T105_ = osLastError_ZQxqnPZsO7WoZx9aX9a5a9cfQ();
		raiseOSError_86HIIOlD5N61CWaO5GBgqA(T105_, ((NimStringDesc*) &TM_mFfhe8Jm7Jqn2Znr3841fw_3));
	}
	LA93_: ;
	hi = (NI32)0;
	low = (NI32)0;
	low = Dl_129611_(result.fHandle, (&hi));
	{
		NI32 T120_;
		if (!(low == ((NI32) -1))) goto LA108_;
		result.mem = NIM_NIL;
		result.size = ((NI) 0);
		{
			NI32 T114_;
			if (!!((result.fHandle == ((NI) 0)))) goto LA112_;
			T114_ = (NI32)0;
			T114_ = Dl_127603_(result.fHandle);
		}
		LA112_: ;
		{
			NI32 T119_;
			if (!!((result.mapHandle == ((NI) 0)))) goto LA117_;
			T119_ = (NI32)0;
			T119_ = Dl_127603_(result.mapHandle);
		}
		LA117_: ;
		T120_ = (NI32)0;
		T120_ = osLastError_ZQxqnPZsO7WoZx9aX9a5a9cfQ();
		raiseOSError_86HIIOlD5N61CWaO5GBgqA(T120_, ((NimStringDesc*) &TM_mFfhe8Jm7Jqn2Znr3841fw_3));
	}
	goto LA106_;
	LA108_: ;
	{
		NI64 fileSize;
		fileSize = (NI64)((NI64)((NU64)(((NI64) (hi))) >> (NU64)(((NI) 32))) | ((NI64) (low)));
		{
			if (!!((mappedSize == ((NI) -1)))) goto LA124_;
			result.size = ((NI) (((fileSize <= ((NI64) (mappedSize))) ? fileSize : ((NI64) (mappedSize)))));
		}
		goto LA122_;
		LA124_: ;
		{
			result.size = ((NI) (fileSize));
		}
		LA122_: ;
	}
	LA106_: ;
	result.wasOpened = NIM_TRUE;
	{
		NIM_BOOL T129_;
		T129_ = (NIM_BOOL)0;
		T129_ = !(allowRemap);
		if (!(T129_)) goto LA130_;
		T129_ = !((result.fHandle == ((NI) -1)));
		LA130_: ;
		if (!T129_) goto LA131_;
		{
			NI32 T135_;
			T135_ = (NI32)0;
			T135_ = Dl_127603_(result.fHandle);
			if (!(T135_ == ((NI32) 0))) goto LA136_;
			result.fHandle = ((NI) -1);
		}
		LA136_: ;
	}
	LA131_: ;
	return result;
}

N_NIMCALL(void, close_nK8O9cRK8tfFl5he9bLSP9bNQ)(MemFile_j4SnXNrJDFBxAz4BlbM9aIQ* f) {
	NIM_BOOL error;
	NI32 lastErr;
	error = NIM_FALSE;
	lastErr = (NI32)0;
	{
		NI32 T5_;
		NIM_BOOL T6_;
		NI32 T7_;
		if (!(*f).wasOpened) goto LA3_;
		T5_ = (NI32)0;
		T5_ = Dl_129801_((*f).mem);
		error = (T5_ == ((NI32) 0));
		lastErr = osLastError_ZQxqnPZsO7WoZx9aX9a5a9cfQ();
		T6_ = (NIM_BOOL)0;
		T7_ = (NI32)0;
		T7_ = Dl_127603_((*f).mapHandle);
		T6_ = (T7_ == ((NI32) 0));
		if (T6_) goto LA8_;
		T6_ = error;
		LA8_: ;
		error = T6_;
		{
			NIM_BOOL T13_;
			NI32 T14_;
			if (!!(((*f).fHandle == ((NI) -1)))) goto LA11_;
			T13_ = (NIM_BOOL)0;
			T14_ = (NI32)0;
			T14_ = Dl_127603_((*f).fHandle);
			T13_ = (T14_ == ((NI32) 0));
			if (T13_) goto LA15_;
			T13_ = error;
			LA15_: ;
			error = T13_;
		}
		LA11_: ;
	}
	LA3_: ;
	(*f).size = ((NI) 0);
	(*f).mem = NIM_NIL;
	(*f).fHandle = ((NI) 0);
	(*f).mapHandle = ((NI) 0);
	(*f).wasOpened = NIM_FALSE;
	{
		if (!error) goto LA18_;
		raiseOSError_86HIIOlD5N61CWaO5GBgqA(lastErr, ((NimStringDesc*) &TM_mFfhe8Jm7Jqn2Znr3841fw_3));
	}
	LA18_: ;
}
NIM_EXTERNC N_NOINLINE(void, stdlib_memfilesInit000)(void) {
}

NIM_EXTERNC N_NOINLINE(void, stdlib_memfilesDatInit000)(void) {
static TNimNode* TM_mFfhe8Jm7Jqn2Znr3841fw_2[5];
static TNimNode TM_mFfhe8Jm7Jqn2Znr3841fw_0[6];
NTI_j4SnXNrJDFBxAz4BlbM9aIQ_.size = sizeof(MemFile_j4SnXNrJDFBxAz4BlbM9aIQ);
NTI_j4SnXNrJDFBxAz4BlbM9aIQ_.kind = 18;
NTI_j4SnXNrJDFBxAz4BlbM9aIQ_.base = 0;
NTI_j4SnXNrJDFBxAz4BlbM9aIQ_.flags = 3;
TM_mFfhe8Jm7Jqn2Znr3841fw_2[0] = &TM_mFfhe8Jm7Jqn2Znr3841fw_0[1];
TM_mFfhe8Jm7Jqn2Znr3841fw_0[1].kind = 1;
TM_mFfhe8Jm7Jqn2Znr3841fw_0[1].offset = offsetof(MemFile_j4SnXNrJDFBxAz4BlbM9aIQ, mem);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[1].typ = (&NTI_vr5DoT1jILTGdRlYv1OYpw_);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[1].name = "mem";
TM_mFfhe8Jm7Jqn2Znr3841fw_2[1] = &TM_mFfhe8Jm7Jqn2Znr3841fw_0[2];
TM_mFfhe8Jm7Jqn2Znr3841fw_0[2].kind = 1;
TM_mFfhe8Jm7Jqn2Znr3841fw_0[2].offset = offsetof(MemFile_j4SnXNrJDFBxAz4BlbM9aIQ, size);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[2].typ = (&NTI_rR5Bzr1D5krxoo1NcNyeMA_);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[2].name = "size";
TM_mFfhe8Jm7Jqn2Znr3841fw_2[2] = &TM_mFfhe8Jm7Jqn2Znr3841fw_0[3];
TM_mFfhe8Jm7Jqn2Znr3841fw_0[3].kind = 1;
TM_mFfhe8Jm7Jqn2Znr3841fw_0[3].offset = offsetof(MemFile_j4SnXNrJDFBxAz4BlbM9aIQ, fHandle);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[3].typ = (&NTI_rR5Bzr1D5krxoo1NcNyeMA_);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[3].name = "fHandle";
TM_mFfhe8Jm7Jqn2Znr3841fw_2[3] = &TM_mFfhe8Jm7Jqn2Znr3841fw_0[4];
TM_mFfhe8Jm7Jqn2Znr3841fw_0[4].kind = 1;
TM_mFfhe8Jm7Jqn2Znr3841fw_0[4].offset = offsetof(MemFile_j4SnXNrJDFBxAz4BlbM9aIQ, mapHandle);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[4].typ = (&NTI_rR5Bzr1D5krxoo1NcNyeMA_);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[4].name = "mapHandle";
TM_mFfhe8Jm7Jqn2Znr3841fw_2[4] = &TM_mFfhe8Jm7Jqn2Znr3841fw_0[5];
TM_mFfhe8Jm7Jqn2Znr3841fw_0[5].kind = 1;
TM_mFfhe8Jm7Jqn2Znr3841fw_0[5].offset = offsetof(MemFile_j4SnXNrJDFBxAz4BlbM9aIQ, wasOpened);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[5].typ = (&NTI_VaVACK0bpYmqIQ0mKcHfQQ_);
TM_mFfhe8Jm7Jqn2Znr3841fw_0[5].name = "wasOpened";
TM_mFfhe8Jm7Jqn2Znr3841fw_0[0].len = 5; TM_mFfhe8Jm7Jqn2Znr3841fw_0[0].kind = 2; TM_mFfhe8Jm7Jqn2Znr3841fw_0[0].sons = &TM_mFfhe8Jm7Jqn2Znr3841fw_2[0];
NTI_j4SnXNrJDFBxAz4BlbM9aIQ_.node = &TM_mFfhe8Jm7Jqn2Znr3841fw_0[0];
}

